<!DOCTYPE html>
<html>
<head>
  <title>Accounts Heads</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h2>Accounts Heads</h2>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addModal">Add Account Head</button>

    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>AH Type</th>
          <th>Amount Types</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="accountHeadTable"></tbody>
    </table>
  </div>

  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Add Account Head</h5></div>
        <div class="modal-body">
          <input type="text" id="addName" class="form-control mb-2" placeholder="Name">
          <select id="addAHType" class="form-control mb-2">
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
          </select>
          <label>Amount Types</label>
          <select id="addAmountTypes" class="form-control" multiple></select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveAddBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Account Head</h5></div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <input type="text" id="editName" class="form-control mb-2">
          <select id="editAHType" class="form-control mb-2">
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
          </select>
          <label>Amount Types</label>
          <select id="editAmountTypes" class="form-control" multiple></select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveEditBtn">Update</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const apiUrl = 'http://127.0.0.1:8000/accounts/accounts-heads/';
    const amountTypesUrl = 'http://127.0.0.1:8000/accounts/amount-types/';

    const accountHeadTable = document.getElementById('accountHeadTable');
    const addAmountTypes = document.getElementById('addAmountTypes');
    const editAmountTypes = document.getElementById('editAmountTypes');

    let amountTypeMap = {};

    async function fetchAmountTypes() {
      const res = await fetch(amountTypesUrl);
      const types = await res.json();
      amountTypeMap = {};
      addAmountTypes.innerHTML = '';
      editAmountTypes.innerHTML = '';

      types.forEach(t => {
        amountTypeMap[t.id] = t.type;
        const option1 = new Option(t.type, t.id);
        const option2 = new Option(t.type, t.id);
        addAmountTypes.add(option1);
        editAmountTypes.add(option2);
      });
    }

    async function fetchAccountHeads() {
      const res = await fetch(apiUrl);
      const heads = await res.json();
      accountHeadTable.innerHTML = '';
      heads.forEach(h => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${h.id}</td>
          <td>${h.name}</td>
          <td>${h.AH_Type}</td>
          <td>${h.Amount_Type.map(id => amountTypeMap[id]).join(', ')}</td>
          <td>
            <button class="btn btn-sm btn-info me-1" onclick='openEditModal(${JSON.stringify(h)})'>Edit</button>
            <button class="btn btn-sm btn-danger" onclick='deleteHead(${h.id})'>Delete</button>
          </td>
        `;
        accountHeadTable.appendChild(row);
      });
    }

    async function deleteHead(id) {
      if (confirm("Delete this Account Head?")) {
        await fetch(`${apiUrl}${id}/`, { method: 'DELETE' });
        fetchAccountHeads();
      }
    }

    
    document.getElementById('saveAddBtn').addEventListener('click', async () => {
        const name = document.getElementById('addName').value.trim();
        const AH_Type = document.getElementById('addAHType').value;
        const types = Array.from(addAmountTypes.selectedOptions).map(o => parseInt(o.value));

        if (!name || types.length === 0) return alert("Name and amount types are required");

        await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, AH_Type, Amount_Type: types })
        });

        // Clear form
        document.getElementById('addName').value = '';
        addAmountTypes.selectedIndex = -1;

        // Close modal properly
        const addModalEl = document.getElementById('addModal');
        const addModal = bootstrap.Modal.getInstance(addModalEl);
        addModal.hide();

        fetchAccountHeads();
    });


    function openEditModal(head) {
      document.getElementById('editId').value = head.id;
      document.getElementById('editName').value = head.name;
      document.getElementById('editAHType').value = head.AH_Type;
      Array.from(editAmountTypes.options).forEach(opt => {
        opt.selected = head.Amount_Type.includes(parseInt(opt.value));
      });
      new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    
    document.getElementById('saveEditBtn').addEventListener('click', async () => {
        const id = document.getElementById('editId').value;
        const name = document.getElementById('editName').value.trim();
        const AH_Type = document.getElementById('editAHType').value;
        const types = Array.from(editAmountTypes.selectedOptions).map(o => parseInt(o.value));

        if (!name || types.length === 0) return alert("Name and amount types required");

        await fetch(`${apiUrl}${id}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, AH_Type, Amount_Type: types })
        });

        // Close modal properly
        const editModalEl = document.getElementById('editModal');
        const editModal = bootstrap.Modal.getInstance(editModalEl);
        editModal.hide();

        fetchAccountHeads();
    });


    // Initial load
    fetchAmountTypes().then(fetchAccountHeads);
  </script>
</body>
</html>

